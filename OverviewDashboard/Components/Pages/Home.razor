@page "/"
@using Microsoft.EntityFrameworkCore
@using OverviewDashboard.Data
@using OverviewDashboard.Models
@using System.Text.Json
@inject IServiceScopeFactory ScopeFactory
@rendermode InteractiveServer
@implements IAsyncDisposable

<PageTitle>System Overview Dashboard</PageTitle>

<div class="dashboard-container">
    <!-- Left Navigation Panel -->
    <div class="nav-panel">
        <div class="nav-header">
            <h2>Systems Overview</h2>
            <div class="timestamp">@DateTime.Now.ToString("T")</div>
        </div>

        <div class="nav-content">
            @{
                var systemGroups = components.GroupBy(c => c.SystemName).OrderBy(g => g.Key);
            }
            @foreach (var systemGroup in systemGroups)
            {
                var systemName = systemGroup.Key;
                var systemSeverity = GetWorstSeverity(systemGroup.ToList());
                var isSystemSelected = selectedSystem == systemName;
                var errorCount = systemGroup.Count(c => GetSeverity(c) == "error");
                var warningCount = systemGroup.Count(c => GetSeverity(c) == "warning");

                <div class="nav-item @(isSystemSelected ? "active" : "")" @onclick="() => SelectSystem(systemName)">
                    <span class="nav-item-name">@systemName</span>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        @if (errorCount > 0)
                        {
                            <span class="nav-item-badge badge-error">@errorCount</span>
                        }
                        @if (warningCount > 0)
                        {
                            <span class="nav-item-badge badge-warning">@warningCount</span>
                        }
                    </div>
                </div>

                @if (isSystemSelected)
                {
                    @foreach (var projectGroup in systemGroup.GroupBy(c => c.ProjectName).OrderBy(g => g.Key))
                    {
                        var projectName = projectGroup.Key;
                        var projectSeverity = GetWorstSeverity(projectGroup.ToList());
                        var isProjectSelected = selectedProject == projectName;
                        var projectErrorCount = projectGroup.Count(c => GetSeverity(c) == "error");
                        var projectWarningCount = projectGroup.Count(c => GetSeverity(c) == "warning");

                        <div class="nav-subitem @(isProjectSelected ? "active" : "")" @onclick="() => SelectProject(systemName, projectName)">
                            <span>@projectName</span>
                            <div style="display: flex; gap: 5px; align-items: center;">
                                @if (projectErrorCount > 0)
                                {
                                    <span class="nav-item-badge badge-error">@projectErrorCount</span>
                                }
                                @if (projectWarningCount > 0)
                                {
                                    <span class="nav-item-badge badge-warning">@projectWarningCount</span>
                                }
                            </div>
                        </div>
                    }
                }
            }
        </div>
    </div>

    <!-- Right Content Area -->
    <div class="content-area">
        <div class="content-header">
            <h1>@contentTitle</h1>
            <p>@contentSubtitle</p>
        </div>

        @if (contextComponents != null && contextComponents.Any())
        {
            <!-- Summary Cards -->
            <div class="cards-container">
                @{
                    var counts = new Dictionary<string, int> { { "ok", 0 }, { "warning", 0 }, { "error", 0 }, { "info", 0 } };
                    foreach (var c in contextComponents)
                    {
                        var severity = GetSeverity(c);
                        if (counts.ContainsKey(severity)) counts[severity]++;
                    }
                }

                <div class="summary-card card-ok @(activeFilter == "ok" ? "active-filter" : "")" @onclick='() => FilterBySeverity("ok")'>
                    <div class="card-icon-bg">‚úì</div>
                    <div class="card-label">OK</div>
                    <div class="card-value">@counts["ok"]</div>
                </div>

                <div class="summary-card card-warning @(activeFilter == "warning" ? "active-filter" : "")" @onclick='() => FilterBySeverity("warning")'>
                    <div class="card-icon-bg">‚ö†</div>
                    <div class="card-label">Warning</div>
                    <div class="card-value">@counts["warning"]</div>
                </div>

                <div class="summary-card card-error @(activeFilter == "error" ? "active-filter" : "")" @onclick='() => FilterBySeverity("error")'>
                    <div class="card-icon-bg">‚úï</div>
                    <div class="card-label">Error</div>
                    <div class="card-value">@counts["error"]</div>
                </div>

                <div class="summary-card card-info @(activeFilter == "info" ? "active-filter" : "")" @onclick='() => FilterBySeverity("info")'>
                    <div class="card-icon-bg">‚Ñπ</div>
                    <div class="card-label">Info</div>
                    <div class="card-value">@counts["info"]</div>
                </div>
            </div>

            <style>
                .summary-card {
                    cursor: pointer;
                    transition: transform 0.2s, box-shadow 0.2s;
                }
                .summary-card:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
                }
                .active-filter {
                    border: 3px solid white;
                    transform: scale(1.05);
                }
                .card-ok.active-filter { box-shadow: 0 0 15px rgba(40, 167, 69, 0.6); }
                .card-warning.active-filter { box-shadow: 0 0 15px rgba(255, 193, 7, 0.6); }
                .card-error.active-filter { box-shadow: 0 0 15px rgba(220, 53, 69, 0.6); }
                .card-info.active-filter { box-shadow: 0 0 15px rgba(23, 162, 184, 0.6); }

                .search-box {
                    padding: 8px 12px;
                    border: 1px solid #dfe6e9;
                    border-radius: 5px;
                    width: 250px;
                    font-size: 14px;
                    outline: none;
                    transition: border-color 0.3s;
                }
                .search-box:focus {
                    border-color: #3498db;
                }

                .btn-clear {
                    padding: 10px 20px;
                    background: #95a5a6;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    transition: all 0.3s;
                    margin-top: 10px;
                }
                .btn-clear:hover {
                    background: #7f8c8d;
                }
            </style>

            <!-- Dynamic Data Table -->
            <div class="table-container">
                <div class="table-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>@filteredComponents.Count Components</h3>
                    <input type="text" class="search-box" placeholder="Search..." @bind="searchText" @bind:event="oninput" />
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th @onclick='() => SortBy("CreatedAt")' style="cursor: pointer;">
                                Created At @GetSortIndicator("CreatedAt")
                            </th>
                            @foreach (var header in GetDynamicHeaders())
                            {
                                <th @onclick="() => SortBy(header)" style="cursor: pointer;">
                                    @header @GetSortIndicator(header)
                                </th>
                            }
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var component in filteredComponents)
                        {
                            var payload = ParsePayload(component.Payload);
                            <tr>
                                <td class="timestamp-cell">@GetRelativeTime(component.CreatedAt)</td>
                                @foreach (var header in GetDynamicHeaders())
                                {
                                    <td>
                                        @if (payload.TryGetValue(header, out var value))
                                        {
                                            @if (header.Equals("Severity", StringComparison.OrdinalIgnoreCase))
                                            {
                                                <span class="severity-badge severity-@value.ToString()?.ToLower()">@value</span>
                                            }
                                            else
                                            {
                                                @value
                                            }
                                        }
                                    </td>
                                }
                                <td>
                                    <button class="delete-btn" @onclick="() => DeleteComponent(component.Id)">üóëÔ∏è</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div style="padding: 2rem; text-align: center; color: #666;">
                @if (components.Any())
                {
                    <p>Select a system or project from the left navigation to view components.</p>
                }
                else
                {
                    <p>No components found. Waiting for data...</p>
                }
            </div>
        }
    </div>
</div>

@code {
    private List<Component> components = new();
    private List<Component> contextComponents = new();
    private List<Component> filteredComponents = new();
    
    private string? selectedSystem;
    private string? selectedProject;
    private string? activeFilter;
    
    private string contentTitle = "System Overview";
    private string contentSubtitle = "Select a system to view details";
    
    private System.Threading.Timer? _timer;

    private string? _sortColumn;
    private bool _sortAscending = true;

    private string _searchText = "";
    private string searchText
    {
        get => _searchText;
        set
        {
            _searchText = value;
            ApplyFilters();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();

        _timer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await RefreshData();
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
    }

    public async ValueTask DisposeAsync()
    {
        if (_timer is not null)
        {
            await _timer.DisposeAsync();
        }
    }

    private async Task LoadData()
    {
        using var scope = ScopeFactory.CreateScope();
        var dbContext = scope.ServiceProvider.GetRequiredService<DashboardDbContext>();
        components = await dbContext.Components.ToListAsync();
        
        if (selectedProject != null && selectedSystem != null)
        {
            SelectProject(selectedSystem, selectedProject);
        }
        else if (selectedSystem != null)
        {
            SelectSystem(selectedSystem);
        }
    }

    private async Task RefreshData()
    {
        await LoadData();
    }
    private void SelectSystem(string systemName)
    {
        selectedSystem = systemName;
        selectedProject = null;
        contentTitle = $"{systemName} Overview";
        contentSubtitle = "System Details";
        
        activeFilter = null;
        _searchText = "";
        
        contextComponents = components.Where(c => c.SystemName == systemName).ToList();
        ApplyFilters();
    }

    private void SelectProject(string systemName, string projectName)
    {
        selectedSystem = systemName;
        selectedProject = projectName;
        contentTitle = $"{systemName} - {projectName}";
        contentSubtitle = "Project Details";
        
        activeFilter = null;
        _searchText = "";
        
        contextComponents = components.Where(c => c.SystemName == systemName && c.ProjectName == projectName).ToList();
        ApplyFilters();
    }

    private void FilterBySeverity(string severity)
    {
        if (activeFilter == severity)
            activeFilter = null;
        else
            activeFilter = severity;
            
        ApplyFilters();
    }

    private void ClearFilter()
    {
        activeFilter = null;
        _searchText = "";
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        var query = contextComponents.AsEnumerable();

        if (!string.IsNullOrEmpty(activeFilter))
        {
            query = query.Where(c => GetSeverity(c).Equals(activeFilter, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(_searchText))
        {
            var term = _searchText.Trim();
            query = query.Where(c => 
                c.Payload.Contains(term, StringComparison.OrdinalIgnoreCase) ||
                GetRelativeTime(c.CreatedAt).Contains(term, StringComparison.OrdinalIgnoreCase)
            );
        }

        filteredComponents = query.ToList();
        
        // Apply sorting if a column is selected
        if (!string.IsNullOrEmpty(_sortColumn))
        {
            filteredComponents = SortComponents(filteredComponents, _sortColumn, _sortAscending);
        }
    }

    private void SortBy(string column)
    {
        if (_sortColumn == column)
        {
            // Toggle sort direction if same column
            _sortAscending = !_sortAscending;
        }
        else
        {
            // New column, default to ascending
            _sortColumn = column;
            _sortAscending = true;
        }
        
        ApplyFilters(); // Re-apply filters with new sort
    }

    private string GetSortIndicator(string column)
    {
        if (_sortColumn != column) return "";
        return _sortAscending ? " ‚ñ≤" : " ‚ñº";
    }

    private List<Component> SortComponents(List<Component> components, string column, bool ascending)
    {
        if (column == "CreatedAt")
        {
            return ascending 
                ? components.OrderBy(c => c.CreatedAt).ToList()
                : components.OrderByDescending(c => c.CreatedAt).ToList();
        }
        
        // Sort by payload field
        var sorted = components.Select(c => new
        {
            Component = c,
            Payload = ParsePayload(c.Payload),
            SortValue = ParsePayload(c.Payload).TryGetValue(column, out var val) ? val.ToString() : ""
        });

        sorted = ascending
            ? sorted.OrderBy(x => x.SortValue)
            : sorted.OrderByDescending(x => x.SortValue);

        return sorted.Select(x => x.Component).ToList();
    }

    private async Task DeleteComponent(int id)
    {
        using var scope = ScopeFactory.CreateScope();
        var dbContext = scope.ServiceProvider.GetRequiredService<DashboardDbContext>();

        var component = await dbContext.Components.FindAsync(id);
        if (component != null)
        {
            dbContext.Components.Remove(component);
            await dbContext.SaveChangesAsync();
            await RefreshData();
        }
    }

    private Dictionary<string, object> ParsePayload(string json)
    {
        try
        {
            return JsonSerializer.Deserialize<Dictionary<string, object>>(json) ?? new Dictionary<string, object>();
        }
        catch
        {
            return new Dictionary<string, object>();
        }
    }

    private List<string> GetDynamicHeaders()
    {
        if (contextComponents == null || !contextComponents.Any()) return new List<string>();

        var headers = new HashSet<string>();
        foreach (var component in contextComponents)
        {
            var payload = ParsePayload(component.Payload);
            foreach (var key in payload.Keys)
            {
                headers.Add(key);
            }
        }
        
        var headerList = headers.OrderBy(h => h).ToList();
        if (headerList.Contains("Severity"))
        {
            headerList.Remove("Severity");
            headerList.Insert(0, "Severity");
        }
        
        // Hide Id column as requested
        if (headerList.Contains("Id"))
        {
            headerList.Remove("Id");
        }
        
        return headerList;
    }

    private string GetSeverity(Component component)
    {
        var payload = ParsePayload(component.Payload);
        if (payload.TryGetValue("Severity", out var severity))
        {
            return severity.ToString()?.ToLower() ?? "info";
        }
        return "info";
    }

    private string GetWorstSeverity(List<Component> components)
    {
        var severities = components.Select(GetSeverity).ToList();
        if (severities.Contains("error")) return "error";
        if (severities.Contains("warning")) return "warning";
        if (severities.Contains("info")) return "info";
        return "ok";
    }

    private string GetRelativeTime(DateTime dateTime)
    {
        var span = DateTime.UtcNow - dateTime;
        if (span.TotalMinutes < 1) return "Just now";
        if (span.TotalMinutes < 60) return $"{(int)span.TotalMinutes} min ago";
        if (span.TotalHours < 24) return $"{(int)span.TotalHours} hour{((int)span.TotalHours > 1 ? "s" : "")} ago";
        return $"{(int)span.TotalDays} day{((int)span.TotalDays > 1 ? "s" : "")} ago";
    }
}
