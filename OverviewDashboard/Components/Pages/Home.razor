@page "/"
@using Microsoft.EntityFrameworkCore
@using OverviewDashboard.Data
@using OverviewDashboard.Models
@using OverviewDashboard.Services
@using System.Text.Json
@inject DashboardDataService DataService
@inject DashboardStateService StateService
@inject IConfiguration Configuration
@rendermode InteractiveServer
@implements IAsyncDisposable

<PageTitle>System Overview Dashboard</PageTitle>

<style>
    .nav-title-link {
        cursor: pointer;
        transition: color 0.2s, text-shadow 0.2s;
    }
    .nav-title-link:hover {
        color: #3498db;
        text-shadow: 0 0 8px rgba(52, 152, 219, 0.3);
    }
    .health-summary {
        padding: 1rem;
        column-count: 2;
        column-gap: 1rem;
    }
    
    @@media (max-width: 768px) {
        .health-summary {
            column-count: 1;
        }
    }

    .clickable-row {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .clickable-row:hover {
        background-color: rgba(52, 152, 219, 0.1);
    }
    .severity-block {
        break-inside: avoid;
        margin-bottom: 1rem;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        background: white; /* Ensure visibility */
    }
    .severity-block-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 1rem 1.5rem;
        color: white;
        font-size: 1.1rem;
        position: relative;
        overflow: hidden;
    }
    .severity-block-header::before {
        content: '';
        position: absolute;
        right: -20px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 5rem;
        opacity: 0.15;
        font-family: inherit;
    }
    .severity-block-error .severity-block-header::before { content: '‚úï'; }
    .severity-block-warning .severity-block-header::before { content: '‚ö†'; }
    .severity-block-offline .severity-block-header::before { content: '?'; }
    .severity-block-ok .severity-block-header::before { content: '‚úì'; }
    .severity-block-info .severity-block-header::before { content: '‚ìò'; }
    .severity-icon { font-size: 1.5rem; z-index: 1; }
    .severity-title { font-weight: 600; flex: 1; z-index: 1; font-size: 1.2rem; }
    .severity-count { 
        font-size: 2.5rem; 
        font-weight: 800; 
        opacity: 1; 
        z-index: 1; 
        line-height: 1; 
        margin-right: 10px;
        color: white !important;
    }
    .severity-block-content { 
        background: #fff; 
        padding: 0.25rem 0; 
        max-height: 400px;
        overflow-y: auto;
    }
    .severity-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 0.4rem 1.5rem;
        border-bottom: 1px solid #f0f0f0;
    }
    .severity-item:last-child { border-bottom: none; }
    .item-system { color: #666; }
    .item-separator { color: #ccc; }
    .item-project { font-weight: 500; flex: 1; }
    .item-count { background: #f0f0f0; padding: 2px 10px; border-radius: 12px; font-size: 0.85rem; color: #666; }
    .severity-block-error .severity-block-header { background: linear-gradient(135deg, #dc3545, #c82333); }
    .severity-block-warning .severity-block-header { background: linear-gradient(135deg, #ffc107, #e0a800); color: #333; }
    .severity-block-offline .severity-block-header { background: linear-gradient(135deg, #6c757d, #545b62); }
    .severity-block-ok .severity-block-header { background: linear-gradient(135deg, #28a745, #1e7e34); }
    .severity-block-info .severity-block-header { background: linear-gradient(135deg, #17a2b8, #138496); }

    /* Table styles */
    .table-scroll-container {
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
    }
    .table-scroll-container table {
        border-collapse: separate;
        border-spacing: 0;
        width: 100%;
    }
    .table-scroll-container thead th {
        position: sticky;
        top: 0;
        background: linear-gradient(135deg, #2c3e50, #34495e);
        color: white;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Header with pagination inline */
    .table-header-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }
    .table-header-bar h3 {
        margin: 0;
    }
    .header-controls {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }

    /* Inline pagination styles */
    .pagination-inline {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    .pagination-inline button {
        border: 1px solid #ddd;
        background: white;
        cursor: pointer;
        border-radius: 4px;
        font-size: 0.85rem;
        transition: all 0.2s;
    }
    .pagination-inline button:hover:not(:disabled) {
        background: #3498db;
        color: white;
        border-color: #3498db;
    }
    .pagination-inline button:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }
    .pagination-inline .page-info {
        padding: 0 0.5rem;
        font-size: 0.85rem;
        color: #666;
        white-space: nowrap;
    }
    .pagination-inline .page-numbers {
        display: flex;
        gap: 2px;
    }
    .pagination-inline .page-btn {
        min-width: 28px;
        padding: 0.25rem;
        text-align: center;
    }
    .pagination-inline .page-btn.active {
        background: #3498db;
        color: white;
        border-color: #3498db;
    }
    
    .collapse-toggle {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 0.8rem;
        padding: 4px;
        opacity: 0.8;
        z-index: 2;
        transition: opacity 0.2s;
    }
    .collapse-toggle:hover { opacity: 1; }
    
    .severity-more {
        text-align: center;
        padding: 0.5rem;
        color: #666;
        font-size: 0.85rem;
        font-style: italic;
        cursor: pointer;
        background: #f9f9f9;
        border-top: 1px solid #f0f0f0;
    }
    .severity-more:hover { background: #eee; }
</style>

<div class="dashboard-container">
    <!-- Left Navigation Panel -->
    <div class="nav-panel">
        <div class="nav-header">
            <h2 class="nav-title-link" @onclick="GoHome" title="Return to overview">
                <span style="
                    display: inline-block;
                    width: 28px;
                    height: 28px;
                    background-color: currentColor;
                    -webkit-mask: url('favicon.svg') no-repeat center / contain;
                    mask: url('favicon.svg') no-repeat center / contain;
                    margin-right: 8px;
                    vertical-align: bottom;">
                </span>
                Overview Dashboard
            </h2>
            <div class="timestamp" id="live-clock"></div>
        </div>

        <div class="nav-content">
            @foreach (var systemGroup in summaries.GroupBy(s => s.SystemName).OrderBy(g => g.Key))
                {
                    var systemName = systemGroup.Key;
                    var isSystemSelected = selectedSystem == systemName;
                    var systemErrors = systemGroup.Sum(s => s.ErrorCount);
                    var systemWarnings = systemGroup.Sum(s => s.WarningCount);
                    var systemOffline = systemGroup.Sum(s => s.OfflineCount);

                    <div class="nav-item @(isSystemSelected ? "active" : "")" @onclick="() => SelectSystem(systemName)">
                        <span class="nav-item-name">@systemName</span>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            @if (systemErrors > 0)
                            {
                                <span class="nav-item-badge badge-error">@systemErrors</span>
                            }
                            @if (systemWarnings > 0)
                            {
                                <span class="nav-item-badge badge-warning">@systemWarnings</span>
                            }
                            @if (systemOffline > 0)
                            {
                                <span class="nav-item-badge badge-offline">@systemOffline</span>
                            }
                        </div>
                    </div>

                    @if (isSystemSelected)
                    {
                        @foreach (var project in systemGroup.OrderBy(p => p.ProjectName))
                        {
                            var isProjectSelected = selectedProject == project.ProjectName;
                            <div class="nav-subitem @(isProjectSelected ? "active" : "")" @onclick="() => SelectProject(systemName, project.ProjectName)">
                                <span>@project.ProjectName</span>
                                <div style="display: flex; gap: 5px; align-items: center;">
                                    @if (project.ErrorCount > 0)
                                    {
                                        <span class="nav-item-badge badge-error">@project.ErrorCount</span>
                                    }
                                    @if (project.WarningCount > 0)
                                    {
                                        <span class="nav-item-badge badge-warning">@project.WarningCount</span>
                                    }
                                    @if (project.OfflineCount > 0)
                                    {
                                        <span class="nav-item-badge badge-offline">@project.OfflineCount</span>
                                    }
                                </div>
                            </div>
                        }
                    }
                }
        </div>
    </div>

    <!-- Right Content Area -->
    <div class="content-area">
        <div class="content-header">
            <h1>@contentTitle</h1>
            <p>@contentSubtitle</p>
        </div>

        @if (selectedProject != null && selectedSystem != null)
        {
            <!-- Summary Cards -->
            <div class="cards-container">
                <div class="summary-card card-ok @(activeFilter == "ok" ? "active-filter" : "")" @onclick='() => FilterBySeverity("ok")'>
                    <div class="card-icon-bg">‚úì</div>
                    <div class="card-label">OK</div>
                    <div class="card-value">@severityCounts.Ok</div>
                </div>
                <div class="summary-card card-warning @(activeFilter == "warning" ? "active-filter" : "")" @onclick='() => FilterBySeverity("warning")'>
                    <div class="card-icon-bg">‚ö†</div>
                    <div class="card-label">Warning</div>
                    <div class="card-value">@severityCounts.Warning</div>
                </div>
                <div class="summary-card card-error @(activeFilter == "error" ? "active-filter" : "")" @onclick='() => FilterBySeverity("error")'>
                    <div class="card-icon-bg">‚úï</div>
                    <div class="card-label">Error</div>
                    <div class="card-value">@severityCounts.Error</div>
                </div>
                <div class="summary-card card-info @(activeFilter == "info" ? "active-filter" : "")" @onclick='() => FilterBySeverity("info")'>
                    <div class="card-icon-bg">‚ìò</div>
                    <div class="card-label">Info</div>
                    <div class="card-value">@severityCounts.Info</div>
                </div>
                <div class="summary-card card-offline @(activeFilter == "offline" ? "active-filter" : "")" @onclick='() => FilterBySeverity("offline")'>
                    <div class="card-icon-bg">?</div>
                    <div class="card-label">Offline</div>
                    <div class="card-value">@severityCounts.Offline</div>
                </div>
            </div>

            <style>
                .summary-card { cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
                .summary-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
                .active-filter { border: 3px solid white; transform: scale(1.05); }
                .card-ok.active-filter { box-shadow: 0 0 15px rgba(40, 167, 69, 0.6); }
                .card-warning.active-filter { box-shadow: 0 0 15px rgba(255, 193, 7, 0.6); }
                .card-error.active-filter { box-shadow: 0 0 15px rgba(220, 53, 69, 0.6); }
                .card-info.active-filter { box-shadow: 0 0 15px rgba(23, 162, 184, 0.6); }
                .card-offline.active-filter { box-shadow: 0 0 15px rgba(108, 117, 125, 0.6); }
                .search-box { padding: 8px 12px; border: 1px solid #dfe6e9; border-radius: 5px; width: 250px; font-size: 14px; outline: none; transition: border-color 0.3s; }
                .search-box:focus { border-color: #3498db; }
            </style>

            <!-- Data Table with Pagination -->
            <div class="table-container">
                <div class="table-header-bar">
                    <h3>@pagedResult.TotalCount Components</h3>
                    <div class="header-controls">
                        <div class="page-size-selector" style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 0.85rem; color: #666;">Show:</span>
                            <select @bind="PageSize" style="padding: 4px 8px; border-radius: 4px; border: 1px solid #dfe6e9; font-size: 0.85rem;">
                                <option value="15">15</option>
                                <option value="30">30</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="200">200</option>
                            </select>
                        </div>

                        @if (pagedResult.TotalPages > 1)
                        {
                            <div class="pagination-inline">
                                <button @onclick="FirstPage" disabled="@(currentPage <= 1)" title="First page">¬´¬´</button>
                                <button @onclick="PreviousPage" disabled="@(currentPage <= 1)" title="Previous page">¬´</button>

                                <div class="page-numbers">
                                    @foreach (var pageNum in GetPageNumbers())
                                    {
                                        <button class="page-btn @(pageNum == currentPage ? "active" : "")"
                                                @onclick="() => GoToPage(pageNum)">@pageNum</button>
                                    }
                                </div>

                                <button @onclick="NextPage" disabled="@(currentPage >= pagedResult.TotalPages)" title="Next page">¬ª</button>
                                <button @onclick="LastPage" disabled="@(currentPage >= pagedResult.TotalPages)" title="Last page">¬ª¬ª</button>
                                
                                <span class="page-info">Page @currentPage / @pagedResult.TotalPages</span>
                            </div>
                        }
                        <input type="text" class="search-box" placeholder="Search..." @bind="searchText" @bind:event="oninput" @bind:after="OnSearchChanged" />
                    </div>
                </div>

                <div class="table-scroll-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th @onclick='() => SortBy("CreatedAt")' style="cursor: pointer;">
                                    Created At @GetSortIndicator("CreatedAt")
                                </th>
                                @foreach (var header in dynamicHeaders)
                                {
                                    <th @onclick="() => SortBy(header)" style="cursor: pointer;">
                                        @header @GetSortIndicator(header)
                                    </th>
                                }
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var component in pagedResult.Items)
                            {
                                <tr>
                                    <td class="timestamp-cell">@GetRelativeTime(component.CreatedAt)</td>
                                    @foreach (var header in dynamicHeaders)
                                    {
                                        <td>
                                            @if (component.ParsedPayload.TryGetValue(header, out var value))
                                            {
                                                @if (header.Equals("Severity", StringComparison.OrdinalIgnoreCase))
                                                {
                                                    <span class="severity-badge severity-@component.Severity">@component.Severity</span>
                                                }
                                                else
                                                {
                                                    @value
                                                }
                                            }
                                        </td>
                                    }
                                    <td>
                                        <button class="delete-btn" @onclick="() => DeleteComponent(component.Id)">üóëÔ∏è</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
        else if (summaries.Any())
        {
            @* System Health Summary View *@
            <div class="health-summary">
                @{
                    var severityOrder = new[] { "error", "warning", "offline", "ok", "info" };
                    var severityLabels = new Dictionary<string, string>
                    {
                        { "error", "Error" }, { "warning", "Warning" }, { "offline", "Offline" },
                        { "ok", "OK" }, { "info", "Info" }
                    };
                    var severityIcons = new Dictionary<string, string>
                    {
                        { "error", "‚úï" }, { "warning", "‚ö†" }, { "offline", "?" },
                        { "ok", "‚úì" }, { "info", "‚ìò" }
                    };
                }

                @foreach (var severity in severityOrder)
                {
                    var countSelector = severity switch
                    {
                        "error" => (Func<SystemProjectSummary, int>)(s => s.ErrorCount),
                        "warning" => s => s.WarningCount,
                        "offline" => s => s.OfflineCount,
                        "ok" => s => s.OkCount,
                        "info" => s => s.InfoCount,
                        _ => s => 0
                    };

                    var itemsWithSeverity = summaries.Where(s => countSelector(s) > 0).ToList();
                    var totalCount = itemsWithSeverity.Sum(countSelector);

                    if (totalCount > 0)
                    {
                        <div class="severity-block severity-block-@severity">
                            <div class="severity-block-header">
                                <span class="severity-icon">@severityIcons[severity]</span>
                                <span class="severity-title">@severityLabels[severity]</span>
                                <span class="severity-count">@totalCount</span>
                                <button class="collapse-toggle" @onclick="() => ToggleSeverity(severity)">
                                    @(collapsedSeverities.GetValueOrDefault(severity, false) ? "‚ñº" : "‚ñ≤")
                                </button>
                            </div>
                            <div class="severity-block-content" style="@(collapsedSeverities.GetValueOrDefault(severity, false) ? "max-height: none; overflow: visible;" : "")">
                                @{
                                    IEnumerable<SystemProjectSummary> displayItems = itemsWithSeverity;
                                    
                                    if (collapsedSeverities.GetValueOrDefault(severity, false))
                                    {
                                        // When collapsed: Sort by count desc, Take 5
                                        displayItems = itemsWithSeverity
                                            .OrderByDescending(x => countSelector(x))
                                            .Take(5);
                                    }
                                    else
                                    {
                                        // When expanded: Sort by count desc (same as collapsed), then Name
                                        displayItems = itemsWithSeverity
                                            .OrderByDescending(x => countSelector(x))
                                            .ThenBy(x => x.SystemName)
                                            .ThenBy(x => x.ProjectName);
                                    }
                                }

                                @foreach (var item in displayItems)
                                {
                                    <div class="severity-item clickable-row" @onclick="() => SelectProjectWithFilter(item.SystemName, item.ProjectName, severity)">
                                        <span class="item-system">@item.SystemName</span>
                                        <span class="item-separator">‚Ä∫</span>
                                        <span class="item-project">@item.ProjectName</span>
                                        <span class="item-count">@countSelector(item)</span>
                                    </div>
                                }
                                
                                @if (collapsedSeverities.GetValueOrDefault(severity, false) && itemsWithSeverity.Count > 5)
                                {
                                    <div class="severity-more" @onclick="() => ToggleSeverity(severity)">
                                        + @(itemsWithSeverity.Count - 5) more...
                                    </div>
                                }
                            </div>
                        </div>
                    }
                }
            </div>
        }
        else
        {
            <div style="padding: 2rem; text-align: center; color: #666;">
                <p>@(isLoadingSummaries ? "Loading..." : "No components found. Waiting for data...")</p>
            </div>
        }
    </div>
</div>

@code {
    private List<SystemProjectSummary> summaries = new();
    private PagedResult<ComponentViewModel> pagedResult = new();
    private SeverityCounts severityCounts = new();
    private List<string> dynamicHeaders = new();

    private Dictionary<string, bool> collapsedSeverities = new Dictionary<string, bool>();

    private void ToggleSeverity(string severity)
    {
        if (collapsedSeverities.ContainsKey(severity))
        {
            collapsedSeverities[severity] = !collapsedSeverities[severity];
        }
        else
        {
            collapsedSeverities[severity] = true;
        }
    }

    private string? selectedSystem;
    private string? selectedProject;
    private string? activeFilter;
    private string contentTitle = "System Overview";
    private string contentSubtitle = "Select a system to view details";

    private bool isLoadingSummaries = true;

    private string? sortColumn;
    private bool sortAscending = true;
    private string searchText = "";

    // Pagination
    private int currentPage = 1;
    private int _pageSize = 15;
    
    public int PageSize
    {
        get => _pageSize;
        set
        {
            if (_pageSize != value)
            {
                _pageSize = value;
                currentPage = 1;
                _ = LoadComponentsAsync();
            }
        }
    }

    private System.Threading.Timer? _refreshTimer;
    private CancellationTokenSource? _searchCts;

    protected override async Task OnInitializedAsync()
    {
        await LoadSummaries();
        StateService.OnChange += OnStateChanged;

        _refreshTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await LoadSummaries();
                if (selectedProject != null && selectedSystem != null)
                {
                    await LoadComponentsAsync();
                }
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
    }

    private async void OnStateChanged()
    {
        await InvokeAsync(async () =>
        {
            await LoadSummaries();
            if (selectedProject != null && selectedSystem != null)
            {
                await LoadComponentsAsync();
            }
            StateHasChanged();
        });
    }

    public async ValueTask DisposeAsync()
    {
        StateService.OnChange -= OnStateChanged;
        if (_refreshTimer != null) await _refreshTimer.DisposeAsync();
        _searchCts?.Cancel();
    }

    private async Task LoadSummaries()
    {
        summaries = await DataService.GetSystemProjectSummariesAsync();
        
        // Default to collapsed for any new severities seen (if dictionary empty)
        if (!collapsedSeverities.Any())
        {
            var severities = new[] { "error", "warning", "offline", "ok", "info" };
            foreach (var s in severities) collapsedSeverities[s] = true;
        }

        isLoadingSummaries = false;
    }

    private async Task LoadComponentsAsync()
    {
        if (selectedSystem == null || selectedProject == null) return;

        var severityTask = DataService.GetSeverityCountsAsync(selectedSystem, selectedProject);
        var headersTask = DataService.GetDynamicHeadersAsync(selectedSystem, selectedProject);
        var dataTask = DataService.GetComponentsPagedAsync(
            selectedSystem, selectedProject, activeFilter, searchText,
            currentPage, _pageSize, sortColumn, sortAscending);

        await Task.WhenAll(severityTask, headersTask, dataTask);

        severityCounts = severityTask.Result;
        dynamicHeaders = headersTask.Result;
        pagedResult = dataTask.Result;
    }

    // Pagination methods
    private async Task FirstPage()
    {
        currentPage = 1;
        await LoadComponentsAsync();
    }

    private async Task PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            await LoadComponentsAsync();
        }
    }

    private async Task NextPage()
    {
        if (currentPage < pagedResult.TotalPages)
        {
            currentPage++;
            await LoadComponentsAsync();
        }
    }

    private async Task LastPage()
    {
        currentPage = pagedResult.TotalPages;
        await LoadComponentsAsync();
    }

    private async Task GoToPage(int page)
    {
        currentPage = page;
        await LoadComponentsAsync();
    }

    private IEnumerable<int> GetPageNumbers()
    {
        var total = pagedResult.TotalPages;
        var current = currentPage;

        // Show max 7 page buttons
        int start = Math.Max(1, current - 3);
        int end = Math.Min(total, start + 6);
        start = Math.Max(1, end - 6);

        for (int i = start; i <= end; i++)
        {
            yield return i;
        }
    }

    private void GoHome()
    {
        selectedSystem = null;
        selectedProject = null;
        activeFilter = null;
        searchText = "";
        currentPage = 1;
        contentTitle = "System Overview";
        contentSubtitle = "Overall system health summary";
        pagedResult = new();
    }

    private async Task SelectSystem(string systemName)
    {
        selectedSystem = systemName;
        var firstProject = summaries.FirstOrDefault(s => s.SystemName == systemName);
        if (firstProject != null)
        {
            await SelectProject(systemName, firstProject.ProjectName);
        }
    }

    private async Task SelectProject(string systemName, string projectName, bool resetFilters = true)
    {
        selectedSystem = systemName;
        selectedProject = projectName;
        contentTitle = $"{systemName} - {projectName}";
        contentSubtitle = "Project Details";

        if (resetFilters)
        {
            activeFilter = null;
            searchText = "";
            sortColumn = null;
            currentPage = 1;
        }

        await LoadComponentsAsync();
    }

    private async Task SelectProjectWithFilter(string systemName, string projectName, string severity)
    {
        selectedSystem = systemName;
        selectedProject = projectName;
        activeFilter = severity;
        searchText = "";
        currentPage = 1;
        contentTitle = $"{systemName} - {projectName}";
        contentSubtitle = "Project Details";

        await LoadComponentsAsync();
    }

    private async Task FilterBySeverity(string severity)
    {
        activeFilter = activeFilter == severity ? null : severity;
        currentPage = 1;
        await LoadComponentsAsync();
    }

    private async Task OnSearchChanged()
    {
        _searchCts?.Cancel();
        _searchCts = new CancellationTokenSource();

        try
        {
            await Task.Delay(300, _searchCts.Token);
            currentPage = 1;
            await LoadComponentsAsync();
        }
        catch (TaskCanceledException) { }
    }

    private async Task SortBy(string column)
    {
        if (sortColumn == column)
        {
            sortAscending = !sortAscending;
        }
        else
        {
            sortColumn = column;
            sortAscending = true;
        }
        currentPage = 1;
        await LoadComponentsAsync();
    }

    private string GetSortIndicator(string column)
    {
        if (sortColumn != column) return "";
        return sortAscending ? " ‚ñ≤" : " ‚ñº";
    }

    private async Task DeleteComponent(int id)
    {
        await DataService.DeleteComponentAsync(id);
        await LoadSummaries();
        await LoadComponentsAsync();
    }

    private static string GetRelativeTime(DateTime dateTime)
    {
        var span = DateTime.UtcNow - dateTime;
        if (span.TotalMinutes < 1) return "Just now";
        if (span.TotalMinutes < 60) return $"{(int)span.TotalMinutes} min ago";
        if (span.TotalHours < 24) return $"{(int)span.TotalHours} hour{((int)span.TotalHours > 1 ? "s" : "")} ago";
        return $"{(int)span.TotalDays} day{((int)span.TotalDays > 1 ? "s" : "")} ago";
    }
}

<script>
    function updateClock() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', { hour12: false });
        const clockElement = document.getElementById('live-clock');
        if (clockElement) {
            clockElement.textContent = timeString;
        }
    }
    updateClock();
    setInterval(updateClock, 1000);
</script>
