@page "/"
@using Microsoft.EntityFrameworkCore
@using OverviewDashboard.Data
@using OverviewDashboard.Models
@inject IServiceScopeFactory ScopeFactory
@rendermode InteractiveServer
@implements IAsyncDisposable

<PageTitle>System Overview Dashboard</PageTitle>

<div class="dashboard-container">
    <!-- Left Navigation Panel -->
    <div class="nav-panel">
        <div class="nav-header">
            <h2>Systems Overview</h2>
            <div class="timestamp">@DateTime.Now.ToString("T")</div>
        </div>

        @* <div class="nav-search">
            <input type="text" placeholder="Search systems..." @bind="searchTerm" @bind:event="oninput" />
        </div> *@

        <div class="nav-content">
            @foreach (var system in filteredSystems)
            {
                var counts = CalculateSystemSeverity(system);
                var worstSeverity = GetWorstSeverity(counts);

                <div class="nav-item @(selectedSystemId == system.Id ? "active" : "")">
                    <span class="nav-item-name" @onclick="() => SelectSystem(system.Id)">@system.Name</span>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <span class="nav-item-badge badge-@worstSeverity">@counts[worstSeverity]</span>
                        <button class="delete-btn-small" @onclick="() => DeleteSystem(system.Id)" @onclick:stopPropagation="true">üóëÔ∏è</button>
                    </div>
                </div>

                @foreach (var project in system.Projects)
                {
                    var projectCounts = CalculateProjectSeverity(project);
                    var projectWorst = GetWorstSeverity(projectCounts);

                    <div class="nav-subitem @(selectedProjectId == project.Id ? "active" : "")">
                        <span @onclick="() => SelectProject(system.Id, project.Id)">@project.Name</span>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <span class="nav-item-badge badge-@projectWorst">@projectCounts[projectWorst]</span>
                            <button class="delete-btn-small" @onclick="() => DeleteProject(project.Id)" @onclick:stopPropagation="true">üóëÔ∏è</button>
                        </div>
                    </div>
                }
            }
        </div>
    </div>

    <!-- Right Content Area -->
    <div class="content-area">
        <div class="content-header">
            <h1>@contentTitle</h1>
            <p>@contentSubtitle</p>
        </div>

        @if (currentComponents != null && currentComponents.Any())
        {
            <!-- Summary Cards -->
            <div class="cards-container">
                @{
                    var counts = new Dictionary<string, int> { { "ok", 0 }, { "warning", 0 }, { "error", 0 }, { "info", 0 } };
                    foreach (var c in currentComponents)
                    {
                        if (counts.ContainsKey(c.Severity.ToLower()))
                            counts[c.Severity.ToLower()]++;
                    }
                }

                <div class="summary-card card-ok @(activeFilter == "ok" ? "active" : "")" @onclick='() => FilterBySeverity("ok")'>
                    <div class="card-icon-bg">‚úì</div>
                    <div class="card-label">OK</div>
                    <div class="card-value">@counts["ok"]</div>
                    <div class="card-subtitle">Healthy components</div>
                </div>

                <div class="summary-card card-warning @(activeFilter == "warning" ? "active" : "")" @onclick='() => FilterBySeverity("warning")'>
                    <div class="card-icon-bg">‚ö†</div>
                    <div class="card-label">Warning</div>
                    <div class="card-value">@counts["warning"]</div>
                    <div class="card-subtitle">Needs attention</div>
                </div>

                <div class="summary-card card-error @(activeFilter == "error" ? "active" : "")" @onclick='() => FilterBySeverity("error")'>
                    <div class="card-icon-bg">‚úï</div>
                    <div class="card-label">Error</div>
                    <div class="card-value">@counts["error"]</div>
                    <div class="card-subtitle">Critical issues</div>
                </div>

                <div class="summary-card card-info @(activeFilter == "info" ? "active" : "")" @onclick='() => FilterBySeverity("info")'>
                    <div class="card-icon-bg">‚Ñπ</div>
                    <div class="card-label">Info</div>
                    <div class="card-value">@counts["info"]</div>
                    <div class="card-subtitle">Informational</div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="table-container">
                <div class="table-header">
                    <h3>@filteredComponents.Count Components</h3>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Component</th>
                            <th>Severity</th>
                            <th>Value</th>
                            <th>Metric</th>
                            <th>Description</th>
                            <th>Last Updated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var component in filteredComponents)
                        {
                            <tr>
                                <td><strong>@component.Name</strong></td>
                                <td><span class="severity-badge severity-@component.Severity.ToLower()">@component.Severity.ToUpper()</span></td>
                                <td><strong>@component.Value</strong></td>
                                <td><span class="metric-badge">@component.Metric</span></td>
                                <td>@component.Description</td>
                                <td class="timestamp-cell">@GetRelativeTime(component.LastUpdate)</td>
                                <td>
                                    <button class="delete-btn" @onclick="() => DeleteComponent(component.Id)">üóëÔ∏è</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <p>Select a system or project from the left navigation to view components.</p>
        }
    </div>
</div>

@code {
    private List<SystemEntity> systems = new();
    private List<SystemEntity> filteredSystems = new();
    private List<Component> currentComponents = new();
    private List<Component> filteredComponents = new();

    private int? selectedSystemId;
    private int? selectedProjectId;
    private string _searchTerm = string.Empty;
    private string activeFilter = string.Empty;
    private string searchTerm
    {
        get => _searchTerm;
        set
        {
            _searchTerm = value;
            FilterNavigation();
        }
    }
    private string contentTitle = "Select a System";
    private string contentSubtitle = "Choose a system or project from the left navigation";
    private System.Threading.Timer? _timer;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();

        // Setup auto-refresh timer (every 5 seconds)
        _timer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await RefreshData();
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
    }

    public async ValueTask DisposeAsync()
    {
        if (_timer is not null)
        {
            await _timer.DisposeAsync();
        }
    }

    private async Task LoadData()
    {
        using var scope = ScopeFactory.CreateScope();
        var dbContext = scope.ServiceProvider.GetRequiredService<DashboardDbContext>();

        systems = await dbContext.Systems
            .Include(s => s.Projects)
            .ThenInclude(p => p.Components)
            .ToListAsync();
        filteredSystems = systems;
    }

    private void FilterNavigation()
    {
        if (string.IsNullOrWhiteSpace(_searchTerm))
        {
            filteredSystems = systems;
        }
        else
        {
            filteredSystems = systems.Where(s =>
                s.Name.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                s.Projects.Any(p => p.Name.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase))
            ).ToList();
        }
        StateHasChanged();
    }

    private void SelectSystem(int systemId)
    {
        selectedSystemId = systemId;
        selectedProjectId = null;
        activeFilter = string.Empty;
        var system = systems.FirstOrDefault(s => s.Id == systemId);
        if (system != null)
        {
            contentTitle = system.Name;
            contentSubtitle = "All Projects";
            currentComponents = system.Projects.SelectMany(p => p.Components).ToList();
            filteredComponents = currentComponents;
        }
    }

    private void SelectProject(int systemId, int projectId)
    {
        selectedSystemId = systemId;
        selectedProjectId = projectId;
        activeFilter = string.Empty;
        var system = systems.FirstOrDefault(s => s.Id == systemId);
        var project = system?.Projects.FirstOrDefault(p => p.Id == projectId);
        if (project != null)
        {
            contentTitle = $"{system!.Name} - {project.Name}";
            contentSubtitle = project.Name;
            currentComponents = project.Components.ToList();
            filteredComponents = currentComponents;
        }
    }

    private void FilterBySeverity(string severity)
    {
        // Toggle filter if clicking the same card again
        if (activeFilter == severity)
        {
            activeFilter = string.Empty;
            filteredComponents = currentComponents;
        }
        else
        {
            activeFilter = severity;
            filteredComponents = currentComponents.Where(c => c.Severity.Equals(severity, StringComparison.OrdinalIgnoreCase)).ToList();
        }
    }

    private async Task RefreshData()
    {
        await LoadData();
        if (selectedProjectId.HasValue)
        {
            SelectProject(selectedSystemId!.Value, selectedProjectId.Value);
        }
        else if (selectedSystemId.HasValue)
        {
            SelectSystem(selectedSystemId.Value);
        }
    }

    private async Task DeleteComponent(int id)
    {
        using var scope = ScopeFactory.CreateScope();
        var dbContext = scope.ServiceProvider.GetRequiredService<DashboardDbContext>();

        var component = await dbContext.Components.FindAsync(id);
        if (component != null)
        {
            dbContext.Components.Remove(component);
            await dbContext.SaveChangesAsync();
            await RefreshData();
        }
    }

    private async Task DeleteSystem(int id)
    {
        using var scope = ScopeFactory.CreateScope();
        var dbContext = scope.ServiceProvider.GetRequiredService<DashboardDbContext>();

        var system = await dbContext.Systems
            .Include(s => s.Projects)
            .ThenInclude(p => p.Components)
            .FirstOrDefaultAsync(s => s.Id == id);

        if (system != null)
        {
            dbContext.Systems.Remove(system);
            await dbContext.SaveChangesAsync();

            // Clear selection if deleted system was selected
            if (selectedSystemId == id)
            {
                selectedSystemId = null;
                selectedProjectId = null;
                currentComponents = new();
                filteredComponents = new();
                contentTitle = "Select a System";
                contentSubtitle = "Choose a system or project from the left navigation";
            }

            await RefreshData();
        }
    }

    private async Task DeleteProject(int id)
    {
        using var scope = ScopeFactory.CreateScope();
        var dbContext = scope.ServiceProvider.GetRequiredService<DashboardDbContext>();

        var project = await dbContext.Projects
            .Include(p => p.Components)
            .FirstOrDefaultAsync(p => p.Id == id);

        if (project != null)
        {
            dbContext.Projects.Remove(project);
            await dbContext.SaveChangesAsync();

            // Clear selection if deleted project was selected
            if (selectedProjectId == id)
            {
                selectedProjectId = null;
                if (selectedSystemId.HasValue)
                {
                    SelectSystem(selectedSystemId.Value);
                }
            }

            await RefreshData();
        }
    }

    private Dictionary<string, int> CalculateSystemSeverity(SystemEntity system)
    {
        var counts = new Dictionary<string, int> { { "ok", 0 }, { "warning", 0 }, { "error", 0 }, { "info", 0 } };
        foreach (var project in system.Projects)
        {
            foreach (var component in project.Components)
            {
                var severity = component.Severity.ToLower();
                if (counts.ContainsKey(severity))
                    counts[severity]++;
            }
        }
        return counts;
    }

    private Dictionary<string, int> CalculateProjectSeverity(Project project)
    {
        var counts = new Dictionary<string, int> { { "ok", 0 }, { "warning", 0 }, { "error", 0 }, { "info", 0 } };
        foreach (var component in project.Components)
        {
            var severity = component.Severity.ToLower();
            if (counts.ContainsKey(severity))
                counts[severity]++;
        }
        return counts;
    }

    private string GetWorstSeverity(Dictionary<string, int> counts)
    {
        if (counts["error"] > 0) return "error";
        if (counts["warning"] > 0) return "warning";
        if (counts["info"] > 0) return "info";
        return "ok";
    }

    private string GetRelativeTime(DateTime dateTime)
    {
        var span = DateTime.UtcNow - dateTime;
        if (span.TotalMinutes < 1) return "Just now";
        if (span.TotalMinutes < 60) return $"{(int)span.TotalMinutes} min ago";
        if (span.TotalHours < 24) return $"{(int)span.TotalHours} hour{((int)span.TotalHours > 1 ? "s" : "")} ago";
        return $"{(int)span.TotalDays} day{((int)span.TotalDays > 1 ? "s" : "")} ago";
    }
}
