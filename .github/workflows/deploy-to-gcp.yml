name: Build and Deploy to GCP

on:
  push:
    branches:
      - main  # Change this to your preferred branch
  workflow_dispatch:  # Allows manual triggering

env:
  IMAGE_NAME: overview-dashboard
  CONTAINER_NAME: overview-dashboard

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t ${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker tag ${{ env.IMAGE_NAME }}:${{ github.sha }} ${{ env.IMAGE_NAME }}:latest

      - name: Save Docker image
        run: docker save ${{ env.IMAGE_NAME }}:latest -o image.tar

      - name: Fix image permissions
        run: chmod 644 image.tar

      - name: Resolve IP
        run: |
          echo "GCP_IP=$(dig +short ${{ secrets.GCP_HOST }} | tail -n1)" >> $GITHUB_ENV

      - name: Check image size
        run: ls -lh image.tar

      - name: Copy image to GCP instance
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.GCP_IP }}
          username: ${{ secrets.GCP_USERNAME }}
          key: ${{ secrets.GCP_SSH_KEY }}
      - name: Copy files to GCP instance
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.GCP_IP }}
          username: ${{ secrets.GCP_USERNAME }}
          key: ${{ secrets.GCP_SSH_KEY }}
          source: "image.tar,docker-compose.yml"
          target: "/tmp/"
          timeout: "300s"

      - name: Deploy to GCP instance
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.GCP_IP }}
          username: ${{ secrets.GCP_USERNAME }}
          key: ${{ secrets.GCP_SSH_KEY }}
          script: |
            # Load the Docker image
            docker load -i /tmp/image.tar
            
            # Create deployment directory
            mkdir -p ~/overview-dashboard
            mv /tmp/docker-compose.yml ~/overview-dashboard/
            cd ~/overview-dashboard
            
            # Stop and remove existing container if it exists (migration from docker run)
            docker stop ${{ env.CONTAINER_NAME }} 2>/dev/null || true
            docker rm ${{ env.CONTAINER_NAME }} 2>/dev/null || true
            
            # Run with Docker Compose
            # Pass IMAGE_NAME to the compose file if needed, but we hardcoded it in compose.
            # Actually, we should ensure the image name matches.
            # The compose file uses "overview-dashboard:latest".
            
            docker compose up -d --remove-orphans
            
            # Clean up
            rm /tmp/image.tar
            
            # Remove old images (keep last 3)
            docker image prune -af --filter "until=72h"
            
            # Show running containers
            docker compose ps

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.GCP_IP }}
          username: ${{ secrets.GCP_USERNAME }}
          key: ${{ secrets.GCP_SSH_KEY }}
          script: |
            echo "Checking container health..."
            sleep 5
            docker logs --tail 50 ${{ env.CONTAINER_NAME }}
